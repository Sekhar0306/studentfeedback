<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Feedback Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        .feedback-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .feedback-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
        }
        .dark .feedback-card:hover {
             box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #EA4C89; /* Dribbble Pink */
            animation: spin 1s ease infinite;
        }
         .dark .spinner {
            border-color: rgba(255, 255, 255, 0.2);
            border-left-color: #EC4899;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-[#F9F9F9] dark:bg-[#1A1A1A] text-gray-900 dark:text-gray-200 transition-colors duration-300">

    <div class="absolute top-4 right-4">
        <button id="theme-toggle" type="button" class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5">
            <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
            <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
        </button>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-3xl">
        <header class="text-center mb-10">
            <h1 class="text-5xl md:text-6xl font-extrabold text-gray-900 dark:text-white">Student Feedback</h1>
            <p class="text-gray-500 dark:text-gray-400 mt-3 text-lg">A modern platform to manage academic feedback.</p>
        </header>

        <main class="space-y-10">
            <div class="bg-white dark:bg-[#202020] p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800">
                <h2 class="text-2xl font-bold mb-5">Submit Feedback</h2>
                <form id="feedbackForm">
                    <fieldset id="feedbackFieldset" class="space-y-4">
                        <div>
                            <label for="studentName" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Student Name</label>
                            <input type="text" id="studentName" name="studentName" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="e.g., Jane Doe" required>
                        </div>
                        <div>
                            <label for="courseName" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Course Name</label>
                            <input type="text" id="courseName" name="courseName" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="e.g., Advanced Web Design" required>
                        </div>
                        <div>
                            <label for="feedbackText" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Feedback</label>
                            <textarea id="feedbackText" name="feedbackText" rows="4" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="What went well? What could be improved?" required></textarea>
                        </div>
                        <button type="submit" id="submitFeedbackBtn" class="w-full mt-2 bg-pink-500 text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-pink-600 transition duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-pink-500 dark:focus:ring-offset-gray-900">Submit Feedback</button>
                    </fieldset>
                    <div id="formError" class="pt-2 text-sm text-red-600 dark:text-red-400"></div>
                </form>
            </div>

            <div class="bg-white dark:bg-[#202020] p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800">
                <h2 class="text-2xl font-bold mb-5">âœ¨ AI-Powered Summary</h2>
                <fieldset id="summaryFieldset">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="summaryCourseName" class="flex-grow px-4 py-2 bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="Enter Course Name">
                        <button id="summarizeBtn" class="bg-pink-500 text-white font-semibold py-2.5 px-6 rounded-lg hover:bg-pink-600 transition duration-300 flex items-center justify-center">
                            <span id="summarizeBtnText">Summarize</span>
                            <div id="summarizeLoader" class="spinner hidden ml-2"></div>
                        </button>
                    </div>
                </fieldset>
                <div id="summaryResult" class="mt-4 p-4 prose prose-sm dark:prose-invert max-w-none bg-gray-100 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700/50 rounded-lg hidden"></div>
                <div id="summaryError" class="mt-4 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-500/30 text-red-700 dark:text-red-300 rounded-lg hidden"></div>
            </div>

            <div class="bg-white dark:bg-[#202020] p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-800">
                <h2 class="text-2xl font-bold mb-5">ðŸŽ“ AI Course Recommendations</h2>
                <fieldset id="recommendFieldset">
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="studentInterests" class="flex-grow px-4 py-2 bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., 'data science, python'">
                        <button id="recommendBtn" class="bg-blue-500 text-white font-semibold py-2.5 px-6 rounded-lg hover:bg-blue-600 transition duration-300 flex items-center justify-center">
                            <span id="recommendBtnText">Recommend</span>
                            <div id="recommendLoader" class="spinner hidden ml-2" style="border-left-color: #3B82F6;"></div>
                        </button>
                    </div>
                </fieldset>
                <div id="recommendResult" class="mt-4 p-4 prose prose-sm dark:prose-invert max-w-none bg-gray-100 dark:bg-gray-800/50 border border-gray-200 dark:border-gray-700/50 rounded-lg hidden"></div>
                <div id="recommendError" class="mt-4 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-500/30 text-red-700 dark:text-red-300 rounded-lg hidden"></div>
            </div>

            <div>
                <h2 class="text-3xl font-bold mb-6 text-center">Submitted Feedback</h2>
                <div id="feedbackList" class="space-y-4">
                    <p id="noFeedbackMessage" class="text-center text-gray-500 dark:text-gray-400 py-8">No feedback submitted yet. Be the first!</p>
                </div>
            </div>
        </main>
    </div>

    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-[#202020] p-6 rounded-2xl shadow-xl w-full max-w-md border border-gray-200 dark:border-gray-800">
            <h2 class="text-2xl font-bold mb-5">Edit Feedback</h2>
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="editFeedbackId">
                <div>
                    <label for="editStudentName" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Student Name</label>
                    <input type="text" id="editStudentName" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg" required>
                </div>
                <div>
                    <label for="editCourseName" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Course Name</label>
                    <input type="text" id="editCourseName" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg" required>
                </div>
                <div>
                    <label for="editFeedbackText" class="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">Feedback</label>
                    <textarea id="editFeedbackText" rows="4" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg" required></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-2">
                    <button type="button" id="cancelEdit" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">Cancel</button>
                    <button type="submit" class="bg-pink-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-pink-600 transition">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white dark:bg-[#202020] p-6 rounded-2xl shadow-xl w-full max-w-sm border border-gray-200 dark:border-gray-800">
            <h2 id="confirmTitle" class="text-xl font-bold mb-4">Confirm Deletion</h2>
            <p id="confirmMessage" class="text-gray-600 dark:text-gray-300 mb-6">Are you sure you want to delete this feedback?</p>
            <div class="flex justify-end gap-3">
                <button type="button" id="cancelConfirm" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition">Cancel</button>
                <button type="button" id="confirmAction" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition">Delete</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const AI_MODEL_NAME = 'gemini-2.5-flash-preview-05-20';
        const FIRESTORE_COLLECTION_NAME = 'feedback';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "...", projectId: "..." };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-feedback-app';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const feedbackForm = document.getElementById('feedbackForm');
        const feedbackFieldset = document.getElementById('feedbackFieldset');
        const summaryFieldset = document.getElementById('summaryFieldset');
        const recommendFieldset = document.getElementById('recommendFieldset');
        const formError = document.getElementById('formError');
        const feedbackList = document.getElementById('feedbackList');
        const noFeedbackMessage = document.getElementById('noFeedbackMessage');
        
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const cancelEditBtn = document.getElementById('cancelEdit');
        
        const confirmModal = document.getElementById('confirmModal');
        const confirmMessage = document.getElementById('confirmMessage');
        const cancelConfirmBtn = document.getElementById('cancelConfirm');
        const confirmActionBtn = document.getElementById('confirmAction');

        const summarizeBtn = document.getElementById('summarizeBtn');
        const summaryCourseNameInput = document.getElementById('summaryCourseName');
        const summaryResult = document.getElementById('summaryResult');
        const summaryError = document.getElementById('summaryError');
        const summarizeLoader = document.getElementById('summarizeLoader');
        const summarizeBtnText = document.getElementById('summarizeBtnText');

        const recommendBtn = document.getElementById('recommendBtn');
        const studentInterests = document.getElementById('studentInterests');
        const recommendResult = document.getElementById('recommendResult');
        const recommendError = document.getElementById('recommendError');
        const recommendLoader = document.getElementById('recommendLoader');
        const recommendBtnText = document.getElementById('recommendBtnText');

        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
        const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');
        
        let currentUserId = null;
        let feedbackCollectionRef = null;
        let confirmActionCallback = null;

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                themeToggleLightIcon.classList.remove('hidden');
                themeToggleDarkIcon.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                themeToggleDarkIcon.classList.remove('hidden');
                themeToggleLightIcon.classList.add('hidden');
            }
        }

        function toggleTheme() {
            const isDarkMode = document.documentElement.classList.contains('dark');
            const newTheme = isDarkMode ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const initialTheme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
            applyTheme(initialTheme);
        }

        function initAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    const collectionPath = `artifacts/${appId}/public/data/${FIRESTORE_COLLECTION_NAME}`;
                    feedbackCollectionRef = collection(db, collectionPath);
                    listenForFeedback();

                    feedbackFieldset.disabled = false;
                    summaryFieldset.disabled = false;
                    recommendFieldset.disabled = false;
                    feedbackFieldset.classList.remove('opacity-50');
                    summaryFieldset.classList.remove('opacity-50');
                    recommendFieldset.classList.remove('opacity-50');

                } else {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Error during sign-in process:", error);
                        formError.textContent = "Could not connect to the service. Please refresh the page.";
                    }
                }
            });
        }
        
        const handleAddFeedback = async (e) => {
            e.preventDefault();
            formError.textContent = '';
            
            if (!feedbackCollectionRef) {
                formError.textContent = "Database connection not ready. Please wait a moment.";
                return;
            }

            const studentName = feedbackForm.studentName.value.trim();
            const courseName = feedbackForm.courseName.value.trim();
            const feedbackText = feedbackForm.feedbackText.value.trim();

            if (studentName && courseName && feedbackText) {
                try {
                    await addDoc(feedbackCollectionRef, {
                        studentName,
                        courseName,
                        feedbackText,
                        createdAt: serverTimestamp(),
                        authorId: currentUserId
                    });
                    feedbackForm.reset();
                } catch (error) {
                    console.error("Error adding document to Firestore: ", error);
                    formError.textContent = "Failed to submit feedback. Please check your connection and try again.";
                }
            } else {
                formError.textContent = "Please fill out all fields before submitting.";
            }
        };

        function listenForFeedback() {
            if (!feedbackCollectionRef) return;
            
            onSnapshot(feedbackCollectionRef, (snapshot) => {
                const feedbacks = [];
                snapshot.forEach(doc => {
                    feedbacks.push({ ...doc.data(), id: doc.id });
                });
                
                feedbacks.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                renderFeedbackList(feedbacks);
            }, (error) => {
                console.error("Error listening for feedback snapshots:", error);
                feedbackList.innerHTML = `<p class="text-center text-red-500">Could not load feedback. Please try refreshing the page.</p>`;
            });
        }

        const handleUpdateFeedback = async (e) => {
            e.preventDefault();
            const id = editForm.editFeedbackId.value;
            if (!feedbackCollectionRef || !id) return;
            
            const updatedData = {
                studentName: editForm.editStudentName.value.trim(),
                courseName: editForm.editCourseName.value.trim(),
                feedbackText: editForm.editFeedbackText.value.trim(),
            };

            try {
                const docRef = doc(feedbackCollectionRef, id);
                await updateDoc(docRef, updatedData);
                hideEditModal();
            } catch (error) {
                console.error("Error updating document:", error);
            }
        };

        async function deleteFeedback(id) {
            if (!feedbackCollectionRef) return;
            try {
                const docRef = doc(feedbackCollectionRef, id);
                await deleteDoc(docRef);
            } catch (error) {
                console.error("Error deleting document: ", error);
            }
        }
        
        function renderFeedbackList(feedbacks) {
            feedbackList.innerHTML = '';
            
            if (feedbacks.length === 0) {
                noFeedbackMessage.style.display = 'block';
            } else {
                noFeedbackMessage.style.display = 'none';
                feedbacks.forEach(feedback => {
                    const card = createFeedbackCard(feedback);
                    feedbackList.appendChild(card);
                });
            }
        }

        function createFeedbackCard(feedback) {
            const card = document.createElement('div');
            card.className = 'feedback-card bg-white dark:bg-[#202020] p-5 rounded-xl shadow-sm border border-gray-200 dark:border-gray-800';
            
            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="font-bold text-lg text-gray-900 dark:text-white">${escapeHTML(feedback.studentName)}</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Course: <span class="font-semibold text-gray-700 dark:text-gray-300">${escapeHTML(feedback.courseName)}</span></p>
                    </div>
                    <p class="text-xs text-gray-400 dark:text-gray-500">${feedback.createdAt ? new Date(feedback.createdAt.toMillis()).toLocaleString() : 'Just now'}</p>
                </div>
                <p class="text-gray-600 dark:text-gray-300 whitespace-pre-wrap py-2">${escapeHTML(feedback.feedbackText)}</p>
                <div class="mt-4 text-right space-x-2">
                    <button data-id="${feedback.id}" class="edit-btn bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-200 text-sm font-semibold py-1.5 px-3 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition">Edit</button>
                    <button data-id="${feedback.id}" class="delete-btn bg-red-600 text-white text-sm font-semibold py-1.5 px-3 rounded-lg hover:bg-red-700 transition">Delete</button>
                </div>
            `;
            return card;
        }

        function showEditModal(feedback) {
            editForm.editFeedbackId.value = feedback.id;
            editForm.editStudentName.value = feedback.studentName;
            editForm.editCourseName.value = feedback.courseName;
            editForm.editFeedbackText.value = feedback.feedbackText;
            editModal.classList.remove('hidden');
        }

        function hideEditModal() {
            editModal.classList.add('hidden');
        }

        function showConfirmModal(message, callback) {
            confirmMessage.textContent = message;
            confirmActionCallback = callback;
            confirmModal.classList.remove('hidden');
        }

        function hideConfirmModal() {
            confirmModal.classList.add('hidden');
            confirmActionCallback = null;
        }

        async function handleSummarize() {
            const courseName = summaryCourseNameInput.value.trim();
            updateSummaryUI('loading');

            if (!courseName) {
                updateSummaryUI('error', "Please enter a course name to summarize.");
                return;
            }

            try {
                const feedbacks = await fetchFeedbackForCourse(courseName);
                if (feedbacks.length === 0) {
                    updateSummaryUI('error', `No feedback found for the course "${courseName}".`);
                    return;
                }

                const combinedFeedback = feedbacks.map(f => f.feedbackText).join("\n---\n");
                const systemPrompt = "You are an expert academic analyst. Summarize the following student feedback for a course. Provide a balanced overview covering positive points, areas for improvement, and any common themes. Format the summary with clear headings and bullet points for readability.";
                const userQuery = `Please summarize this feedback for the course "${courseName}":\n\n${combinedFeedback}`;
                
                const summaryText = await getAiResponse(userQuery, systemPrompt);
                
                if (summaryText) {
                    updateSummaryUI('success', summaryText);
                } else {
                    throw new Error("The AI model returned an empty summary.");
                }

            } catch (error) {
                console.error("[AI Summary] Error:", error);
                updateSummaryUI('error', "An error occurred while generating the summary. Please try again later.");
            }
        }

        async function handleRecommendCourses() {
            const interests = studentInterests.value.trim();
            updateRecommendUI('loading');

            if (!interests) {
                updateRecommendUI('error', "Please enter some interests to get recommendations.");
                return;
            }

            try {
                const allFeedback = await fetchAllFeedback();
                if (allFeedback.length === 0) {
                    updateRecommendUI('error', `No feedback data available to make recommendations. Please add some feedback first.`);
                    return;
                }
                
                const feedbackContext = allFeedback.map(f => `Course: ${f.courseName}\nFeedback: ${f.feedbackText}`).join('\n\n');

                const systemPrompt = "You are an expert academic advisor. Based on a student's interests and existing course feedback, recommend 3-5 courses. For each recommendation, briefly explain why it's a good fit. Prioritize courses that have generally positive feedback if available.";
                const userQuery = `A student is interested in "${interests}". Based on this and the following feedback data, what courses would you recommend?\n\nFeedback Data:\n${feedbackContext}`;
                
                const recommendationText = await getAiResponse(userQuery, systemPrompt);
                
                if (recommendationText) {
                    updateRecommendUI('success', recommendationText);
                } else {
                    throw new Error("The AI model returned an empty recommendation.");
                }

            } catch (error) {
                console.error("[AI Recommend] Error:", error);
                updateRecommendUI('error', "An error occurred while generating recommendations. Please try again later.");
            }
        }

        async function fetchFeedbackForCourse(courseName) {
            const q = query(feedbackCollectionRef, where("courseName", "==", courseName));
            const querySnapshot = await getDocs(q);
            const feedbacks = [];
            querySnapshot.forEach(doc => feedbacks.push(doc.data()));
            return feedbacks;
        }
        
        async function fetchAllFeedback() {
            const querySnapshot = await getDocs(feedbackCollectionRef);
            const feedbacks = [];
            querySnapshot.forEach(doc => feedbacks.push(doc.data()));
            return feedbacks;
        }

        async function getAiResponse(userQuery, systemPrompt) {
            const apiKey = "AIzaSyBDbEUXHmrPWrS95dIPzKFMb2XKMWRa11A";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${AI_MODEL_NAME}:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.text();
                throw new Error(`API call failed with status: ${response.status}. Body: ${errorBody}`);
            }
            
            const result = await response.json();
            return result.candidates?.[0]?.content?.parts?.[0]?.text || null;
        }
        
        function updateSummaryUI(state, data) {
            summarizeLoader.classList.add('hidden');
            summarizeBtnText.textContent = 'Summarize';
            summarizeBtn.disabled = false;
            summaryResult.classList.add('hidden');
            summaryError.classList.add('hidden');
            
            switch (state) {
                case 'loading':
                    summarizeLoader.classList.remove('hidden');
                    summarizeBtnText.textContent = 'Summarizing...';
                    summarizeBtn.disabled = true;
                    break;
                case 'success':
                    summaryResult.innerHTML = data.replace(/\n/g, '<br>');
                    summaryResult.classList.remove('hidden');
                    break;
                case 'error':
                    summaryError.textContent = data;
                    summaryError.classList.remove('hidden');
                    break;
            }
        }
        
        function updateRecommendUI(state, data) {
            recommendLoader.classList.add('hidden');
            recommendBtnText.textContent = 'Recommend';
            recommendBtn.disabled = false;
            recommendResult.classList.add('hidden');
            recommendError.classList.add('hidden');
            
            switch (state) {
                case 'loading':
                    recommendLoader.classList.remove('hidden');
                    recommendBtnText.textContent = 'Recommending...';
                    recommendBtn.disabled = true;
                    break;
                case 'success':
                    recommendResult.innerHTML = data.replace(/\n/g, '<br>');
                    recommendResult.classList.remove('hidden');
                    break;
                case 'error':
                    recommendError.textContent = data;
                    recommendError.classList.remove('hidden');
                    break;
            }
        }

        function escapeHTML(str) {
            const p = document.createElement("p");
            p.textContent = str;
            return p.innerHTML;
        }
        
        const handleFeedbackListClick = (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            const id = button.dataset.id;
            if (!id) return;

            if (button.classList.contains('delete-btn')) {
                showConfirmModal("Are you sure you want to delete this feedback?", () => {
                    deleteFeedback(id);
                });
            } else if (button.classList.contains('edit-btn')) {
                const card = button.closest('.feedback-card');
                const feedbackData = {
                    id,
                    studentName: card.querySelector('h3').textContent,
                    courseName: card.querySelector('.font-semibold').textContent,
                    feedbackText: card.querySelector('p.text-gray-600').textContent,
                };
                showEditModal(feedbackData);
            }
        };

        function initAppEventListeners() {
            feedbackForm.addEventListener('submit', handleAddFeedback);
            editForm.addEventListener('submit', handleUpdateFeedback);
            feedbackList.addEventListener('click', handleFeedbackListClick);
            summarizeBtn.addEventListener('click', handleSummarize);
            recommendBtn.addEventListener('click', handleRecommendCourses);
            cancelEditBtn.addEventListener('click', hideEditModal);
            cancelConfirmBtn.addEventListener('click', hideConfirmModal);
            themeToggleBtn.addEventListener('click', toggleTheme);
            confirmActionBtn.addEventListener('click', () => {
                if (typeof confirmActionCallback === 'function') {
                    confirmActionCallback();
                }
                hideConfirmModal();
            });
        }
        
        function main() {
            initTheme();
            initAuth();
            initAppEventListeners();

            feedbackFieldset.disabled = true;
            summaryFieldset.disabled = true;
            recommendFieldset.disabled = true;
            feedbackFieldset.classList.add('opacity-50');
            summaryFieldset.classList.add('opacity-50');
            recommendFieldset.classList.add('opacity-50');
        }

        main();

    </script>
</body>
</html>

